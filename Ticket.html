import { getFirestore, doc, getDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

const db = window.db; // Menggunakan Firestore dari `index.html`
const classSelect = document.getElementById("class");
const secabaQuota = document.getElementById("secabaQuota");
const catarQuota = document.getElementById("catarQuota");

let kuotaKelas = {}; // Menyimpan kuota kelas

// Ambil data kuota dari Firestore
async function loadKuota() {
    const docRef = doc(db, "kelas", "kuota"); // Ganti sesuai koleksi di Firestore
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
        const data = docSnap.data();
        kuotaKelas = {
            "SECABA": data.SECABA || 0,
            "CATAR": data.CATAR || 0
        };

        secabaQuota.textContent = kuotaKelas["SECABA"];
        catarQuota.textContent = kuotaKelas["CATAR"];

        // Disable opsi jika kuota habis
        document.querySelector('option[value="SECABA"]').disabled = kuotaKelas["SECABA"] <= 0;
        document.querySelector('option[value="CATAR"]').disabled = kuotaKelas["CATAR"] <= 0;
    } else {
        console.error("❌ Data kuota tidak ditemukan di Firestore!");
    }
}

// Jalankan saat halaman dimuat
loadKuota();

// Fungsi untuk daftar
document.getElementById("registrationForm").addEventListener("submit", async function(event) {
    event.preventDefault();

    const nama = document.getElementById("name").value;
    const discordUsername = document.getElementById("discordUsername").value;
    const robloxUsername = document.getElementById("robloxUsername").value;
    const selectedClass = classSelect.value;

    if (!selectedClass || kuotaKelas[selectedClass] <= 0) {
        alert("Kuota untuk kelas ini sudah habis! Silakan pilih kelas lain.");
        return;
    }

    try {
        // Simpan data pendaftaran ke Firestore
        await addDoc(collection(db, "pendaftaran"), {
            nama,
            discordUsername,
            robloxUsername,
            kelas: selectedClass
        });

        // Kurangi kuota kelas
        const docRef = doc(db, "kelas", "kuota");
        await updateDoc(docRef, {
            [selectedClass]: kuotaKelas[selectedClass] - 1
        });

        alert("✅ Pendaftaran berhasil!");
        location.reload(); // Refresh untuk update kuota
    } catch (error) {
        console.error("❌ Error saat mendaftar:", error);
        alert("Terjadi kesalahan, coba lagi.");
    }
});
